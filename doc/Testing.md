# 详细的产测步骤

### 一些问题

+ 如果串口连锡了怎么办
+ eMMC完全损坏导致的不启动有什么log
+ 什么时候可以拔掉产测线缆（弹窗？）
+ 步骤一里的检测环节不可以使用网络ssh，仅可使用串口访问

## 步骤零：产测主机初始化

+ （暂时没做）检测产测主机是否合格（两个以太网口和两个视频接口）
+ 获取/创建toml配置文件
+ （需要安装软件后手动执行）向Appdata中存储必要文件（产测文件+最新安装包）
+ 配置产测主机编号如果检测到0则需要弹窗提示手动分配
+ 检测USB小板是否存在/损坏
  + 检测不到USB小板：找不到串口+连接失败多次
+ 检测HDMI采集是否存在
+ 检测打印机是否存在
+ 如果不存在则弹窗警告

## 步骤一：初始化

+ 串口状态检测
  + 未连接：超过5s没有发送任何字符，发送回车无响应
  + 已连接：重启所有程序的标志：找到串口+连接失败多次后连接成功
  + 正在启动：超时5s内检测到[  OK  ]
  + 等待登录：检测到login
  + 已经登录：检测到Welcome后检测到#
    + 网络配置：
      + 静态IP：设置完成后上报
      + 动态IP：等待有IP后上报
    + 若近5s内没有数据，发送回车无响应，则回到未连接状态
+ 如果长时间（10s+）未连接，则弹窗请接入测试样品，如果已经接入就点击打印错误贴纸（没有标识贴纸），或者点击取消，清零倒计时
+ 主机设置IP/或不设置
+ 等待串口获取IP并尝试Ping通
+ 检测是否存在已产测信息
  + 若存在
    + 检测核心板+底板是否匹配

    + 弹窗（底板已更换）是否重新完整测试

    + 更新产测信息（比如屏幕需要重测）
+ 检测硬件-更新硬件状态（如果两个I2C都没有检测到就弹窗手动选择）
  + 检测测试保存文件：/etc/testkvm/***.json是否存在
    + 如果不存在就开始检测硬件版本+创建新串号+创建新json文件填写基础信息
    + 如果存在则检测底板是否被替换（json串号和底板串号是否一致）
      + 一致/没有串号：弹窗提示是否重新完整检测

      + ID对不上：弹窗提示：底板已更换，一个重新打印贴纸按钮（生成新串号并覆盖进6911），标记本地存储的旧串号文件不可用

  + 如果检测不到I2C（判断不了版本）就弹窗选择版本，并提示无需拔掉，等待产测完成

+ 测试eMMC
+ SCP或任何方式下载产测内容+简略json
+ 打印贴纸

## 步骤二：项目测试

+ 文件更新
  1. 更新uboot
  2. 更新kernel
  3. 安装APP（不能自启）
+ HDMI测试
  1. 加载ko-开关所有电源一下
  2. 检测本地HDMI是否有两个（检测HDMI IN IO+主机是否有两个）
  3. 测试环出（检测HDMI OUT IO+I2C是否存在+是否有环出画面）
  4. 测试采集检测CSI的读数（具体看张建的实现）+ko/state
  5. 写EDID
  6. 写Version
  7. 结果整理：
     + 本地HDMI不过or测试环出画面不过：修复86102，重复检测，再不行就标记为86102不良
     + 测试采集不过：修复6911，重复检测，再不行就标记为6911不良
     + 记录所有IO不良和画面不良到printer
+ 主机检测USB VID/PID设备是否存在，不存在尝试重置PHY
+ ETH
  1. 用Ping判定是否连接（上面已经做了，可以直接绿）
  2. 上传测速，过不了再测，最多测3次
  3. 下载测速，过不了再测，最多测3次
+ WiFi
  1. 主机创建AP（移动热点方式）账号跟测试主机的名字，密码一样
  2. 尝试连接AP，多次尝试连接，最多测n次
  3. 上传测速，过不了再测，最多测3次
  4. 下载测速，过不了再测，最多测3次
+ 交互
  1. ATX需要检测I2C后弹窗确认
  2. Desk也弹窗，但只要滑动就直接过
  3. 测试旋钮
+ 其他（所有同步）
  + ATX
  + IO
  + TF

## 步骤三：应用设置

+ 收集错误
+ 若没有错误直接配置开机自启+应用配置（还得看一下张建的产测最后还做了什么）
+ 若有问题，打印不良贴纸，如果超过5行/最后一行超过14个字符，可以多打一张



### 小章节：仅通过串口如何做状态管理

+ 串口接口通过一个单独的进程控制读写，所有数据通过两个队列传输
+ 提供队列的读写函数以及读取时候的ANSI格式清除函数
+ 单独一个进程用于串口状态管理和接收信息，功能如下，状态：未连接、启动中、已登陆、错误
  + 是否连接工具
    + 找不到串口：清除其他，count++（MAX：100）
    + 找到串口连接不到：清除其他，count++（MAX：100）
    + 找到串口连接到：状态二count小于6进入已连接，否则清除所有count，进入未连接
  + 任意状态下启用计时器，最大值100s，封顶后归10
  + 任意状态下：只要接收到任何数据计时清零，进入已连接
  + 任意状态下：计时器%5s自动发送回车清零计时器，如无消息进入未连接状态，有消息进入已连接
  + 未连接状态：只要计时大于等于10s就发送弹窗，点击取消就清除倒计时，点击打印不良也清除倒计时同时触发打印选项
  + （暂态/上升沿/函数自动判断）一旦进入已连接，先设置定时器B（清零+开始）
  + 任意状态下：只要出现检测[ OK ]，并进入启动中
  + 任意状态下：定时器B大于60s，进入错误状态，触发弹窗：等待or打印不良贴纸（启动异常，建议重烧镜像）
  + 任意状态下：只要出现login，就自动登录（），等待Welcome + #，进入已登录，停止定时器B
  + 已登录后执行获取IP操作，如果未获取到就重复，直到获取到IP，超过10次获取不到就弹窗提醒连接以太网/打印不良

### 小章节：弹窗管理

+ 需要设置弹窗队列
+ 单个弹窗使用一个进程管理，避免重复触发
+ 可以设置的按键数量+内容：0、1、2
+ 可以设置的弹窗信息



### 一些问题

#### ping

+ 发现原来的ping命令有问题，不能检测time，有一次log如下：

  ```shell
  ping -c 1 172.168.100.1
  From 172.168.100.2 icmp_seq=1 Destination Host Unreachable
  
  --- 172.168.100.1 ping statistics ---
  1 packets transmitted, 0 received, +1 errors, 100% packet loss, time 0ms
  ```

+ 正常的是这样的：

  ```
  ping -c 1 172.168.100.1
  PING 172.168.100.1 (172.168.100.1) 56(84) bytes of data.
  64 bytes from 172.168.100.1: icmp_seq=1 ttl=128 time=1.63 ms
  
  --- 172.168.100.1 ping statistics ---
  1 packets transmitted, 1 received, 0% packet loss, time 0ms
  rtt min/avg/max/mdev = 1.632/1.632/1.632/0.000 ms
  ```

+ 或者未连接一般是这样的：

  ```
  ping -c 1 172.168.100.1
  ping: connect: Network is unreachable
  
  # 或者其他样式
  # 未连接线缆时可能卡死，需要ctrl+c退出
  ```

+ 用`1 received`做判别吧


#### 检测硬件版本

+ Desk

  ```shell
  root@kvm-0733:~# i2cdetect -ry 7
  WARNING! This program can confuse your I2C bus, cause data loss and worse!
  I will probe file /dev/i2c-7 using receive byte commands.
  I will probe address range 0x08-0x77.
  Continue? [Y/n] y
       0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
  00:                         -- -- -- -- -- -- -- --
  10: -- -- -- -- -- UU -- -- -- -- -- -- -- -- -- --
  20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
  30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
  40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
  50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
  60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
  70: -- -- -- -- -- -- -- --
  root@kvm-0733:~#
  ```

+ ATX

  ```shell
  root@kvm-31c6:~# i2cdetect -ry 7
  WARNING! This program can confuse your I2C bus, cause data loss and worse!
  I will probe file /dev/i2c-7 using receive byte commands.
  I will probe address range 0x08-0x77.
  Continue? [Y/n] y
       0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
  00:                         -- -- -- -- -- -- -- --
  10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
  20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
  30: -- -- -- -- -- -- -- -- -- -- -- -- 3c -- -- --
  40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
  50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
  60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
  70: -- -- -- -- -- -- -- --
  root@kvm-31c6:~#
  ```

#### 如何检测有无wifi

+ 无：

  ```shell
  root@kvm-31c6:~# ip a | grep wlan0
  root@kvm-31c6:~#
  ```

+ 有

  ```shell
  root@kvm-0733:~# ip a | grep wlan0
  6: wlan0: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000
  root@kvm-0733:~#
  ```

#### 下载产测步骤

+ 检测是否下载了产测文件，如果没有开始下载，如果有，弹窗询问是否覆盖
+ 如何下载？？

#### 检测硬件的步骤

+ 不存在测试信息+6911空：新硬件，分配串号后，从零开始
+ 存在测试信息+6911空：维修硬件，弹窗是否从零开始
+ 不存在测试信息+6911有：维修硬件（更新过底板），弹窗是否从零开始
+ 存在测试信息+6911相同：维修硬件（未换底板），弹窗是否从零开始
+ 存在测试信息+6911不同：维修硬件（更换底板），弹窗是否从零开始

#### 何为测试信息

+ ```shell
  mkdir /etc/test-kvm
  echo Neal0015B > /etc/test-kvm/serial
  echo > /etc/test-kvm/test_pass
  ```

+ 